# 桌面打包问题修复总结

## 问题

你报告了桌面平台打包后的两个问题：

1. ❌ **图标没有正确显示**
2. ❌ **打开程序直接报错：`Error: java/sql/DriverManager`**

## 根本原因

### 问题 1：图标显示
- Windows 配置指向了不存在的 `.ico` 文件
- 实际只有 `.png` 格式的图标文件

### 问题 2：DriverManager 错误
- **核心原因**：Compose Desktop 打包时没有包含 `java.sql` 模块
- SQLite JDBC 驱动 (`JdbcSqliteDriver`) 依赖 Java 标准库的 SQL 模块
- Java 9+ 模块化系统要求显式声明模块依赖

## 修复方案

已修改 `composeApp/build.gradle.kts` 文件，添加以下配置：

### 1. 添加 java.sql 模块（核心修复）

```kotlin
macOS {
    modules("java.sql")
}
windows {
    modules("java.sql")
}
linux {
    modules("java.sql")
}
```

### 2. 启用完整运行时模块

```kotlin
includeAllModules = true
```

### 3. 修正图标路径

```kotlin
windows {
    iconFile.set(project.file("src/desktopMain/resources/app_icon_windows.png"))
}
```

### 4. 禁用 ProGuard

```kotlin
buildTypes.release.proguard {
    isEnabled.set(false)
}
```

## 下一步操作

### 立即重新打包

```bash
# 1. 清理旧构建
./gradlew clean

# 2. 打包（根据你的平台选择）
./gradlew packageDmg    # macOS
./gradlew packageMsi    # Windows MSI
./gradlew packageExe    # Windows EXE
./gradlew packageDeb    # Linux
```

### 验证修复

1. ✅ 安装新打包的应用
2. ✅ 启动应用，不应再出现 DriverManager 错误
3. ✅ 检查图标是否正确显示
4. ✅ 测试添加播放列表功能
5. ✅ 确认数据库正常工作（`~/.iptv/iptv.db`）

## 技术细节

### java.sql 模块包含的关键类

- `java.sql.DriverManager` - JDBC 驱动管理器
- `java.sql.Connection` - 数据库连接
- `java.sql.Statement` - SQL 语句执行
- `java.sql.ResultSet` - 查询结果集

这些都是 SQLite JDBC 驱动运行所必需的。

### 为什么开发时没问题？

- 开发环境使用完整的 JDK，包含所有模块
- 打包后的应用使用精简的 JRE，只包含显式声明的模块
- 如果不声明 `java.sql`，打包后的应用就会缺少这个模块

## 相关文档

- `桌面打包修复说明.md` - 中文详细说明
- `DESKTOP_PACKAGING_FIX.md` - 英文技术文档
- `QUICK_REPACKAGE_GUIDE.md` - 快速操作指南

## 状态

✅ **已完成修复**  
✅ **配置已验证无语法错误**  
⏳ **等待重新打包测试**

---

**修复时间**: 2024-11-27  
**修改文件**: `composeApp/build.gradle.kts`
