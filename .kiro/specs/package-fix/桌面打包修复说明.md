# 桌面平台打包问题修复说明

## 问题

1. ❌ 图标没有正确显示
2. ❌ 打开程序直接报错：`Error: java/sql/DriverManager`

## 已修复 ✅

我已经修复了 `composeApp/build.gradle.kts` 文件中的配置问题。

### 修复内容

#### 1. 添加 java.sql 模块支持

这是导致 `DriverManager` 错误的根本原因。SQLite 数据库驱动需要 Java 的 SQL 模块才能工作。

```kotlin
macOS {
    modules("java.sql")  // ← 新增
}
windows {
    modules("java.sql")  // ← 新增
}
linux {
    modules("java.sql")  // ← 新增
}
```

#### 2. 启用完整运行时模块

```kotlin
includeAllModules = true  // ← 新增
```

#### 3. 修复图标路径

- macOS: `app_icon.icns` ✅
- Windows: `app_icon_windows.png` ✅
- Linux: `app_icon.png` ✅

#### 4. 禁用 ProGuard

避免代码混淆导致的运行时问题。

## 重新打包步骤

### 1. 清理旧的构建

```bash
./gradlew clean
```

### 2. 根据你的平台打包

**macOS 用户：**
```bash
./gradlew packageDmg
```
打包文件在：`composeApp/build/compose/binaries/main/dmg/`

**Windows 用户：**
```bash
# MSI 安装包
./gradlew packageMsi

# 或 EXE 安装包
./gradlew packageExe
```
打包文件在：`composeApp/build/compose/binaries/main/msi/` 或 `exe/`

**Linux 用户：**
```bash
./gradlew packageDeb
```
打包文件在：`composeApp/build/compose/binaries/main/deb/`

## 验证修复

### 1. 安装并启动应用

安装新打包的应用，然后启动。

### 2. 检查是否还有错误

- ✅ 应该不再出现 `DriverManager` 错误
- ✅ 应用图标应该正确显示
- ✅ 程序可以正常启动

### 3. 测试数据库功能

1. 尝试添加一个播放列表
2. 检查是否能正常保存数据
3. 验证数据库文件是否创建：
   ```bash
   ls -la ~/.iptv/iptv.db
   ```

## 技术说明

### 为什么会出现 DriverManager 错误？

在 Java 9+ 的模块化系统中，`java.sql` 包不再默认包含在所有应用中。SQLite JDBC 驱动需要以下类：

- `java.sql.DriverManager`
- `java.sql.Connection`
- `java.sql.Statement`
- `java.sql.ResultSet`

这些类都在 `java.sql` 模块中。Compose Desktop 打包时必须显式声明包含这个模块。

### 为什么图标没显示？

之前的配置中：
- Windows 配置指向了不存在的 `.ico` 文件
- 路径配置可能不正确

现在已经修正为使用实际存在的图标文件。

## 如果还有问题

### DriverManager 错误仍然存在

1. 检查打包日志，确认 java.sql 模块被包含
2. 尝试完全清理后重新构建：
   ```bash
   ./gradlew clean
   rm -rf build/
   rm -rf composeApp/build/
   ./gradlew packageDmg  # 或其他打包命令
   ```

### 图标仍然不显示

1. 确认图标文件存在：
   ```bash
   ls -la composeApp/src/desktopMain/resources/
   ```

2. 检查图标文件格式和尺寸是否正确

3. 对于 Windows，可以考虑转换为 .ico 格式以获得更好的支持

## 相关文件

- ✅ `composeApp/build.gradle.kts` - 已修复
- ✅ `composeApp/src/desktopMain/resources/` - 图标文件目录
- ✅ `composeApp/src/desktopMain/kotlin/com/menmapro/iptv/data/database/` - 数据库实现

## 总结

两个问题都已经在构建配置中修复：

1. ✅ **DriverManager 错误** - 添加了 `java.sql` 模块
2. ✅ **图标显示问题** - 修正了图标文件路径

现在只需要重新打包即可！
