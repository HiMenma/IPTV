# Desktop黑屏修复 - 测试指南

## 快速测试

### 1. 编译应用
```bash
./gradlew :composeApp:run
```

### 2. 添加播放列表
- 点击右下角"+"按钮
- 添加一个M3U或Xtream播放列表
- 等待加载完成

### 3. 播放视频
- 选择任意频道
- 点击播放
- 观察视频是否正常显示

### 4. 检查日志
在控制台查找以下内容：

**应该看到**:
```
=== Building Media Options ===
  URL type: Live Stream
  ...
  Video output: :vout=caopengllayer  ← 这一行很重要！
  Total options configured: X
==============================
```

**应该看到**:
```
=== Video Codec Information ===
Video Track: 1
  Codec: H264
  Resolution: 1920x1080
  ...
================================
```

**不应该看到**:
```
⚠️ No video track information available  ← 修复后不应出现
```

## 详细测试

### 测试场景1: 直播流
1. 添加一个直播源（如IPTV）
2. 播放频道
3. 验证：
   - ✅ 视频正常显示
   - ✅ 音频正常播放
   - ✅ 视频和音频同步

### 测试场景2: 点播内容
1. 添加一个VOD源
2. 播放视频
3. 验证：
   - ✅ 视频正常显示
   - ✅ 可以拖动进度条
   - ✅ 暂停/播放正常

### 测试场景3: 切换频道
1. 播放第一个频道
2. 切换到第二个频道
3. 再切换回第一个频道
4. 验证：
   - ✅ 每次切换都正常显示
   - ✅ 没有黑屏
   - ✅ 没有卡顿

### 测试场景4: 全屏播放
1. 播放任意频道
2. 点击全屏按钮
3. 验证：
   - ✅ 全屏模式视频正常
   - ✅ 退出全屏正常
   - ✅ 视频不中断

## 平台测试

### macOS测试
- 操作系统: macOS 10.15+
- 预期视频输出: `caopengllayer`
- 特别注意: Retina显示屏的渲染

### Linux测试
- 操作系统: Ubuntu 20.04+
- 预期视频输出: `xcb_x11`
- 特别注意: X11和Wayland的兼容性

### Windows测试
- 操作系统: Windows 10+
- 预期视频输出: `directdraw`
- 特别注意: 高DPI显示的渲染

## 问题诊断

### 如果仍然黑屏

#### 步骤1: 检查日志
查找这些关键信息：
```
Video output: :vout=xxx  ← 是否存在？
Video Track: X           ← 是否检测到视频轨道？
```

#### 步骤2: 检查VLC
```bash
# macOS
/Applications/VLC.app/Contents/MacOS/VLC --version

# Linux
vlc --version

# Windows
"C:\Program Files\VideoLAN\VLC\vlc.exe" --version
```

#### 步骤3: 尝试不同的URL
- 测试不同的视频源
- 尝试不同的格式（HLS, RTSP, HTTP等）

#### 步骤4: 查看完整日志
```bash
./gradlew :composeApp:run 2>&1 | tee app.log
```

然后检查`app.log`文件。

## 性能测试

### CPU使用率
- 播放时CPU使用率应该 < 30%
- 如果过高，可能是硬件加速未启用

### 内存使用
- 播放时内存增长应该 < 100MB
- 长时间播放不应有内存泄漏

### 视频质量
- 画面清晰，无马赛克
- 无卡顿或跳帧
- 音视频同步

## 测试报告模板

```
测试日期: ___________
测试平台: [ ] macOS  [ ] Linux  [ ] Windows
VLC版本: ___________

基本功能:
[ ] 视频正常显示
[ ] 音频正常播放
[ ] 音视频同步

日志检查:
[ ] 包含视频输出选项
[ ] 检测到视频轨道
[ ] 无错误信息

性能:
[ ] CPU使用率正常
[ ] 内存使用正常
[ ] 视频质量良好

问题记录:
1. ___________
2. ___________

总体评价:
[ ] 通过  [ ] 需要修复  [ ] 阻塞性问题

备注:
___________
```

## 自动化测试（未来）

### 单元测试
```kotlin
@Test
fun testVideoOutputOptionIncluded() {
    val options = buildMediaOptions("http://example.com/stream.m3u8")
    assertTrue(options.any { it.contains(":vout=") })
}
```

### 集成测试
```kotlin
@Test
fun testVideoPlaybackWithoutBlackScreen() {
    // 启动播放器
    // 加载视频
    // 验证视频轨道存在
    // 验证视频正在渲染
}
```

## 回归测试

在每次发布前，确保：
1. ✅ 所有平台都能正常播放视频
2. ✅ 没有引入新的黑屏问题
3. ✅ 性能没有下降
4. ✅ 现有功能不受影响

---

**测试完成后，请填写测试报告并提交！** ✅
